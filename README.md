# CommandAI: 您的智能 Zsh 终端助手

`CommandAI` 是一个强大的 Zsh 插件，它集成了大型语言模型 (LLM)，旨在彻底改变您的命令行体验。它提供智能命令纠错、上下文感知命令补全，以及将自然语言翻译成 Shell 命令的能力。

---

## 核心功能

### 1. 智能命令纠错 (Command Correction)
- **触发方式**:
    - **自动触发**: 在命令执行后，通过 `precmd` 钩子检测到“命令未找到”的错误时自动触发。
    - **手动触发**: 用户通过特定命令（如 `ai fix`）主动对上一条或历史命令进行纠错。
- **工作流程**:
    - 捕获执行失败的命令。
    - 调用 AI 大模型进行分析和纠错。
    - 提供交互式选项，让用户选择 `执行`、`放弃` 或 `编辑` 纠正后的命令。

### 2. 智能命令补全 (Intelligent Completion)
- **触发方式**: 用户按下 `Tab` 键或自定义快捷键 (如 `Ctrl+Space`)。
- **工作流程**:
    - 获取当前输入上下文。
    - 调用 AI 大模型生成相关的参数、选项或值。
    - 结合 Zsh 原生补全，异步加载 AI 建议，避免卡顿。
    - 以带描述的列表形式展示补全项。

### 3. 自然语言转命令 (Natural Language to Command)
- **触发方式**: 使用特定前缀 (如 `#` 或 `ai`) + 自然语言描述。
- **工作流程**:
    - 提取自然语言请求。
    - 调用 AI 大模型将其翻译成对应的 Shell 命令。
    - **安全执行**: 生成的命令会填充到输入行，但不会立即执行，交由用户最终确认。

### 4. 常用命令缓存 (Command Cache)
- **触发方式**: 在调用 AI 进行翻译或纠错之前。
- **工作流程**:
    - **缓存查找**: 优先在本地缓存中查找用户的请求（无论是自然语言还是错误命令）。
    - **缓存命中**: 若找到，则直接返回缓存中的命令，实现即时响应并跳过 API 调用。
    - **缓存写入**: 当一个由 AI 生成或纠错的命令被用户成功执行后，该“请求-响应”对将被存入本地缓存。

---

## 安全设计 (Security by Design)

安全性是 CommandAI 的核心原则。我们通过多层防御机制来确保 AI 生成的命令是可信的：

- **风险警告**: AI 模型被特别指示，在生成任何涉及文件删除 (`rm`)、权限修改 (`chmod`)、磁盘操作 (`dd`, `mkfs`) 或远程脚本执行的命令时，必须附加一个明确的风险标签。

- **强制二次确认**: 当插件检测到高风险标签的命令时，会中止正常的执行流程，并用醒目的颜色高亮显示该命令，同时要求用户进行显式的二次确认（例如，输入 `yes`），以防止意外操作。

- **演练模式 (Dry Run) 优先**: 对于支持“演练”模式的工具（如 `rsync`, `kubectl`），AI 会优先生成带有 `--dry-run` 或类似安全参数的命令，让用户可以先预览操作结果，再决定是否实际执行。

- **可配置的黑名单**: 用户可以在配置文件中定义一个命令“黑名单”。任何出现在黑名单中的命令或模式都将被插件拒绝生成和执行，给予用户最终的控制权。

---

## 未来展望 (Future Enhancements)

CommandAI 是一个持续发展的项目，我们计划在未来版本中引入以下增强功能：

### 1. 增强的上下文感知 (Enhanced Context-Awareness)

- **Git 感知**: 当用户处于 Git 仓库中时，AI 将优先提供与 Git 操作相关的建议。例如，在输入 `git com` 时，AI 不仅会补全为 `commit`，还能根据当前仓库状态建议合适的提交信息。
- **项目语言感知**: 自动检测项目类型（Python、Node.js、Go 等），并优先推荐相关的命令和工具链。
- **连接状态感知**: 当用户通过 SSH 连接到远程服务器时，提供与远程维护和文件传输相关的命令建议。

### 2. 用户反馈与自学习 (User Feedback & Self-Improvement)

- **反馈机制**: 用户可以通过简单的命令（如 `ai feedback good` 或 `ai feedback bad`）对 AI 的建议进行评价。
- **智能缓存优化**: 根据用户反馈动态调整缓存权重，优先推荐用户偏好的命令。
- **行为学习**: 通过观察用户的编辑和选择，自动学习并适应用户的使用习惯。

### 3. 异步执行与性能优化 (Asynchronous Execution & Performance)

- **即时响应**: 在等待 AI 响应的同时，立即返回本地缓存或历史记录中的快速建议。
- **后台处理**: 将耗时的 AI 调用移至后台执行，避免阻塞用户界面。
- **智能节流**: 对频繁触发的操作（如连续按 Tab 键）进行节流处理，减少不必要的 API 调用。

---

## 项目架构

项目的目录结构设计如下，以实现模块化和可扩展性：

```
command-ai/
├── command-ai.plugin.zsh         # Zsh 插件入口文件
├── bin/
│   └── command-ai-helper           # 核心逻辑的辅助脚本 (Python/Go/Rust)
├── completions/
│   └── _command-ai                 # Zsh 自定义补全函数
├── modules/
│   ├── correction.zsh            # 命令纠错模块
│   ├── completion.zsh            # 智能补全模块
│   ├── nl2cmd.zsh                # 自然语言转命令模块
│   ├── security.zsh              # 安全设计模块
│   └── cache.zsh                 # 命令缓存模块
├── config.example.ini            # 配置文件模板
├── README.md                     # 项目说明
└── install.sh                    # 安装脚本
```

### 组件说明

1.  **`command-ai.plugin.zsh` (插件入口)**: 加载所有模块、钩子和补全逻辑。
2.  **`bin/command-ai-helper` (核心辅助脚本)**: 使用 Python/Go 等语言编写，负责与 AI API 通信、解析数据和管理配置，将复杂逻辑与 Zsh 分离。
3.  **`modules/*.zsh` (功能模块)**: 每个文件负责一个核心功能 (纠错、补全、自然语言转换)，实现逻辑解耦。
4.  **`completions/_command-ai` (补全函数)**: 标准的 Zsh 补全脚本，用于格式化和展示 AI 返回的补全建议。
5.  **`config.example.ini` (配置文件)**: 存放用户的 API Key、模型选择、自定义 AI 提示词等个性化设置。
6.  **`install.sh` (安装脚本)**: 简化用户的安装和配置过程。

## 自定义 AI 提示词

CommandAI 支持自定义 AI 提示词，让你可以根据个人需求调整 AI 的行为和响应风格。

### 配置方法

在配置文件中添加 `[prompts]` 部分，可以自定义以下三种提示词：

```ini
[prompts]
# 命令纠错系统提示词
correction_system_prompt = 你是一个专业的命令行助手...

# 自然语言转命令系统提示词
translation_system_prompt = 你是一个智能的命令行翻译助手...

# 智能补全系统提示词
completion_system_prompt = 你是一个命令行补全助手...
```

### 提示词类型

1. **`correction_system_prompt`**: 控制命令纠错功能的 AI 行为
   - 用于 `ai fix` 命令和自动纠错
   - 可以调整纠错的严格程度、安全性考虑等

2. **`translation_system_prompt`**: 控制自然语言转命令的 AI 行为
   - 用于 `ai "自然语言描述"` 功能
   - 可以调整语言理解能力、命令风格偏好等

3. **`completion_system_prompt`**: 控制智能补全的 AI 行为
   - 用于 Tab 键智能补全功能
   - 可以调整补全建议的数量、详细程度等

### 自定义示例

项目中提供了 `custom-prompt-example.ini` 文件，展示了如何创建更详细和个性化的提示词：

```bash
# 查看自定义提示词示例
cat custom-prompt-example.ini

# 复制并修改为你的配置
cp custom-prompt-example.ini ~/.config/command-ai/config.ini
```

### 最佳实践

1. **保持简洁**: 提示词应该清晰明了，避免过于复杂的指令
2. **安全优先**: 确保提示词强调安全性，特别是对危险命令的处理
3. **一致性**: 保持不同提示词之间的风格和要求一致
4. **测试验证**: 修改提示词后，测试各种场景确保效果符合预期

如果不配置自定义提示词，CommandAI 将使用内置的默认提示词，已经过优化以提供良好的使用体验。

## 🚀 使用指南

### 快速开始

1. **安装插件**
   ```bash
   ./install.sh
   ```

2. **配置 API Key**
   ```bash
   # 编辑配置文件
   nano ~/.config/command-ai/config.ini
   # 设置你的 API Key
   ```

3. **重新加载 Shell**
   ```bash
   source ~/.zshrc
   ```

4. **开始使用**
   ```bash
   ai help                    # 查看帮助
   ai 列出所有 txt 文件        # 自然语言转命令
   ai fix                     # 修复上一个命令
   # 查找错误日志             # 使用 # 前缀
   ```

### 主要命令

- `ai <自然语言>` - 自然语言转命令
- `ai fix [命令]` - 修复命令
- `ai feedback <good|bad>` - 提供反馈
- `ai cache <stats|clear>` - 缓存管理
- `ai config` - 配置管理
- `ai help` - 显示帮助

### 快捷键

- `Tab` / `Ctrl+Space` - 智能补全
- `# <描述> + Enter` - 自然语言转命令
